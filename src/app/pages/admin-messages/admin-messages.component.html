<div class="admin-messages-container">
  <div class="header">
    <h1>رسائل الإدارة</h1>
  </div>

  <div class="header-buttons">
    <button
      class="refresh-btn"
      (click)="refreshData()"
      aria-label="تحديث البيانات"
    >
      <i class="fas fa-sync-alt"></i>
      تحديث البيانات
    </button>
    <button
      class="reset-deleted-btn"
      (click)="resetDeletedMessages('contact')"
      [disabled]="getDeletedCount('contact') === 0"
    >
      <i class="fas fa-undo"></i>
      إعادة رسائل الاتصال المحذوفة ({{ getDeletedCount("contact") }})
    </button>
    <button
      class="reset-deleted-btn"
      (click)="resetDeletedMessages('join')"
      [disabled]="getDeletedCount('join') === 0"
    >
      <i class="fas fa-undo"></i>
      إعادة رسائل الانضمام المحذوفة ({{ getDeletedCount("join") }})
    </button>
  </div>

  <!-- Contact Messages Section -->
  <div class="section">
    <div class="section-header">
      <h2>رسائل نموذج الاتصال ({{ contactMessages.length }})</h2>
      <div class="filters">
        <div class="data-source-info">
          <span class="data-source" [class]="apiStatus.contact">
            {{ getDataSourceText("contact") }}
          </span>
        </div>
        <div class="bulk-actions">
          <button
            class="select-all-btn"
            (click)="toggleSelectAll('contact')"
            [disabled]="contactMessages.length === 0"
          >
            <i class="fas fa-check-square"></i>
            {{ isAllSelected("contact") ? "إلغاء تحديد الكل" : "تحديد الكل" }}
          </button>
          <button
            class="delete-selected-btn"
            (click)="deleteSelectedMessages('contact')"
            [disabled]="getSelectedCount('contact') === 0"
          >
            <i class="fas fa-trash"></i>
            حذف المحدد ({{ getSelectedCount("contact") }})
          </button>
        </div>
        <button
          class="export-btn"
          (click)="exportCSV('contact')"
          [disabled]="contactMessages.length === 0"
        >
          <i class="fas fa-download"></i>
          تصدير CSV
        </button>
      </div>
    </div>

    <div class="table-container" role="region" aria-label="جدول رسائل الاتصال">
      <!-- Loading State -->
      <div *ngIf="isLoadingContact" class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>جاري تحميل رسائل الاتصال...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="contactError && !isLoadingContact" class="error-state">
        <i class="fas fa-exclamation-triangle"></i>
        <p>{{ contactError }}</p>
        <button class="retry-btn" (click)="refreshData()">
          <i class="fas fa-redo"></i>
          إعادة المحاولة
        </button>
      </div>

      <!-- Empty State -->
      <div
        *ngIf="
          !isLoadingContact && !contactError && contactMessages.length === 0
        "
        class="empty-state"
      >
        <i class="fas fa-inbox"></i>
        <p>لا توجد رسائل اتصال حالياً</p>
      </div>

      <!-- Data Table -->
      <table
        *ngIf="!isLoadingContact && !contactError && contactMessages.length > 0"
        class="data-table"
      >
        <thead>
          <tr>
            <th class="checkbox-column">
              <input
                type="checkbox"
                [checked]="isAllSelected('contact')"
                (change)="toggleSelectAll('contact')"
                [indeterminate]="isPartiallySelected('contact')"
              />
            </th>
            <th>الاسم</th>
            <th>رقم الهاتف</th>
            <th>نوع السيارة</th>
            <th>موديل السيارة</th>
            <th>ملاحظات إضافية</th>
            <th>التاريخ</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let message of contactMessages; let i = index"
            class="message-row"
          >
            <td class="checkbox-column">
              <input
                type="checkbox"
                [checked]="isMessageSelected('contact', i)"
                (change)="toggleMessageSelection('contact', i)"
              />
            </td>
            <td>{{ getDecodedText(message.fullName) }}</td>
            <td>{{ getDecodedText(message.phoneNumber) }}</td>
            <td>{{ getDecodedText(message.carType) }}</td>
            <td>{{ getDecodedText(message.carModel) }}</td>
            <td>{{ getDecodedText(message.notes, "لا توجد ملاحظات") }}</td>
            <td>
              {{
                message.createdAt
                  ? (message.createdAt | date : "short")
                  : "غير محدد"
              }}
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Mobile Cards Layout -->
      <div
        *ngIf="!isLoadingContact && !contactError && contactMessages.length > 0"
        class="mobile-cards"
      >
        <div
          *ngFor="let message of contactMessages; let i = index"
          class="message-card"
        >
          <div class="card-header">
            <div class="card-checkbox">
              <input
                type="checkbox"
                [checked]="isMessageSelected('contact', i)"
                (change)="toggleMessageSelection('contact', i)"
              />
            </div>
            <div class="card-date">
              {{
                message.createdAt
                  ? (message.createdAt | date : "short")
                  : "غير محدد"
              }}
            </div>
          </div>
          <div class="card-content">
            <div class="field-group">
              <span class="field-label">الاسم:</span>
              <div class="field-value">
                {{ getDecodedText(message.fullName) }}
              </div>
            </div>
            <div class="field-group">
              <span class="field-label">رقم الهاتف:</span>
              <div class="field-value">
                {{ getDecodedText(message.phoneNumber) }}
              </div>
            </div>
            <div class="field-group">
              <span class="field-label">نوع السيارة:</span>
              <div class="field-value">
                {{ getDecodedText(message.carType) }}
              </div>
            </div>
            <div class="field-group">
              <span class="field-label">موديل السيارة:</span>
              <div class="field-value">
                {{ getDecodedText(message.carModel) }}
              </div>
            </div>
            <div class="field-group">
              <span class="field-label">ملاحظات إضافية:</span>
              <div class="field-value">
                {{ getDecodedText(message.notes, "لا توجد ملاحظات") }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Join Messages Section -->
  <div class="section">
    <div class="section-header">
      <h2>رسائل نموذج الانضمام ({{ joinMessages.length }})</h2>
      <div class="filters">
        <div class="data-source-info">
          <span class="data-source" [class]="apiStatus.join">
            {{ getDataSourceText("join") }}
          </span>
        </div>
        <div class="bulk-actions">
          <button
            class="select-all-btn"
            (click)="toggleSelectAll('join')"
            [disabled]="joinMessages.length === 0"
          >
            <i class="fas fa-check-square"></i>
            {{ isAllSelected("join") ? "إلغاء تحديد الكل" : "تحديد الكل" }}
          </button>
          <button
            class="delete-selected-btn"
            (click)="deleteSelectedMessages('join')"
            [disabled]="getSelectedCount('join') === 0"
          >
            <i class="fas fa-trash"></i>
            حذف المحدد ({{ getSelectedCount("join") }})
          </button>
        </div>
        <button
          class="export-btn"
          (click)="exportCSV('join')"
          [disabled]="joinMessages.length === 0"
        >
          <i class="fas fa-download"></i>
          تصدير CSV
        </button>
      </div>
    </div>

    <div class="table-container" role="region" aria-label="جدول رسائل الانضمام">
      <!-- Loading State -->
      <div *ngIf="isLoadingJoin" class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>جاري تحميل رسائل الانضمام...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="joinError && !isLoadingJoin" class="error-state">
        <i class="fas fa-exclamation-triangle"></i>
        <p>{{ joinError }}</p>
        <button class="retry-btn" (click)="refreshData()">
          <i class="fas fa-redo"></i>
          إعادة المحاولة
        </button>
      </div>

      <!-- Empty State -->
      <div
        *ngIf="!isLoadingJoin && !joinError && joinMessages.length === 0"
        class="empty-state"
      >
        <i class="fas fa-inbox"></i>
        <p>لا توجد رسائل انضمام حالياً</p>
      </div>

      <!-- Data Table -->
      <table
        *ngIf="!isLoadingJoin && !joinError && joinMessages.length > 0"
        class="data-table"
      >
        <thead>
          <tr>
            <th class="checkbox-column">
              <input
                type="checkbox"
                [checked]="isAllSelected('join')"
                (change)="toggleSelectAll('join')"
                [indeterminate]="isPartiallySelected('join')"
              />
            </th>
            <th>الاسم</th>
            <th>رقم الهاتف</th>
            <th>البريد الإلكتروني</th>
            <th>المنصب المطلوب</th>
            <th>الخبرة السابقة</th>
            <th>الرسالة</th>
            <th>التاريخ</th>
            <th>ملف CV</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let message of joinMessages; let i = index"
            class="message-row"
          >
            <td class="checkbox-column">
              <input
                type="checkbox"
                [checked]="isMessageSelected('join', i)"
                (change)="toggleMessageSelection('join', i)"
              />
            </td>
            <td>{{ getDecodedText(message.fullName) }}</td>
            <td>{{ getDecodedText(message.phoneNumber) }}</td>
            <td>{{ getDecodedText(message.email) }}</td>
            <td>
              {{ getDecodedText(message.jobPosition || message.position) }}
            </td>
            <td>{{ getDecodedText(message.experience) }}</td>
            <td>{{ getDecodedText(message.message, "لا توجد رسالة") }}</td>
            <td>
              {{
                message.createdAt
                  ? (message.createdAt | date : "short")
                  : "غير محدد"
              }}
            </td>
            <td class="cv-column">
              <div *ngIf="hasCV(message)" class="cv-actions">
                <button
                  class="download-cv-btn"
                  (click)="downloadCV(message)"
                  title="تحميل ملف CV"
                >
                  <i class="fas fa-download"></i>
                  تحميل CV
                </button>
                <span class="cv-filename">{{ getCVFileName(message) }}</span>
              </div>
              <span *ngIf="!hasCV(message)" class="no-cv">
                <i class="fas fa-times-circle"></i>
                لا يوجد CV
              </span>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Mobile Cards Layout -->
      <div
        *ngIf="!isLoadingJoin && !joinError && joinMessages.length > 0"
        class="mobile-cards"
      >
        <div
          *ngFor="let message of joinMessages; let i = index"
          class="message-card"
        >
          <div class="card-header">
            <div class="card-checkbox">
              <input
                type="checkbox"
                [checked]="isMessageSelected('join', i)"
                (change)="toggleMessageSelection('join', i)"
              />
            </div>
            <div class="card-date">
              {{
                message.createdAt
                  ? (message.createdAt | date : "short")
                  : "غير محدد"
              }}
            </div>
          </div>
          <div class="card-content">
            <div class="field-group">
              <span class="field-label">الاسم:</span>
              <div class="field-value">
                {{ getDecodedText(message.fullName) }}
              </div>
            </div>
            <div class="field-group">
              <span class="field-label">رقم الهاتف:</span>
              <div class="field-value">
                {{ getDecodedText(message.phoneNumber) }}
              </div>
            </div>
            <div class="field-group">
              <span class="field-label">البريد الإلكتروني:</span>
              <div class="field-value">{{ getDecodedText(message.email) }}</div>
            </div>
            <div class="field-group">
              <span class="field-label">المنصب المطلوب:</span>
              <div class="field-value">
                {{ getDecodedText(message.jobPosition || message.position) }}
              </div>
            </div>
            <div class="field-group">
              <span class="field-label">الخبرة السابقة:</span>
              <div class="field-value">
                {{ getDecodedText(message.experience) }}
              </div>
            </div>
            <div class="field-group">
              <span class="field-label">الرسالة:</span>
              <div class="field-value">
                {{ getDecodedText(message.message, "لا توجد رسالة") }}
              </div>
            </div>
            <div class="cv-section">
              <span class="field-label">ملف CV:</span>
              <div *ngIf="hasCV(message)" class="cv-actions">
                <button
                  class="download-cv-btn"
                  (click)="downloadCV(message)"
                  title="تحميل ملف CV"
                >
                  <i class="fas fa-download"></i>
                  تحميل CV
                </button>
                <div class="cv-filename">{{ getCVFileName(message) }}</div>
              </div>
              <div *ngIf="!hasCV(message)" class="no-cv">
                <i class="fas fa-times-circle"></i>
                لا يوجد CV
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
